<!-- 
    Template des détails d'une licence
    -----------------------------------
    Cette page affiche toutes les informations relatives à une seule licence.
    Elle contient également des sections "Actions" qui permettent de modifier
    l'état de la licence (désactiver, réactiver, prolonger).
    La logique Jinja2 est utilisée pour afficher conditionnellement les actions
    possibles en fonction du statut actuel de la licence.
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détails de la licence - {{ license.license_key | format_license_key }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .navbar-brand img {
            height: 40px;
            margin-right: 10px;
        }
        .license-key {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 1rem;
            border: 1px solid #dee2e6;
        }
        .status-badge {
            font-size: 0.875rem;
        }
        .info-card {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .progress {
            height: 8px;
        }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                Connecteur Sages
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home"></i> Accueil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/licenses/"><i class="fas fa-key"></i> Licences</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/logout"><i class="fas fa-sign-out-alt"></i> Déconnexion</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- En-tête de la page avec un lien de retour au tableau de bord -->
        <div class="mb-6">
            <a href="/licenses/dashboard" class="text-blue-600 hover:underline">&larr; Retour au tableau de bord</a>
        </div>
        
        <!-- Boîte principale contenant les détails -->
        <div class="bg-white shadow-xl rounded-lg overflow-hidden">
            <div class="px-6 py-5 bg-gray-50 border-b border-gray-200">
                <h1 class="text-2xl font-bold text-gray-800">Détails de la licence</h1>
                <p class="text-sm text-gray-600 font-mono mt-1">{{ license.license_key | format_license_key }}</p>
            </div>

            <!-- Grille pour afficher les informations de la licence -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 p-6">
                
                <!-- Section Statut -->
                <div>
                    <h2 class="text-sm font-medium text-gray-500">Statut</h2>
                    <!-- 
                        Badge de statut avec couleur dynamique, similaire au tableau de bord.
                        La couleur dépend du `status_text` calculé dans la route.
                    -->
                    {% set status_color = {
                        'Active': 'bg-green-100 text-green-800',
                        'Expirée': 'bg-red-100 text-red-800',
                        'Désactivée': 'bg-gray-100 text-gray-800',
                        'Limite atteinte': 'bg-yellow-100 text-yellow-800'
                    }.get(status_text, 'bg-gray-100 text-gray-800') %}
                    <p class="mt-1 text-lg font-semibold {{ status_color }} inline-block px-3 py-1 rounded-full">
                        {{ status_text }}
                    </p>
                </div>

                <!-- Section Jours Restants -->
                <div>
                    <h2 class="text-sm font-medium text-gray-500">Validité restante</h2>
                    {% if status_text == 'Active' %}
                        <p class="mt-1 text-lg font-semibold text-gray-900">{{ days_left }} jours</p>
                    {% elif status_text == 'Expirée' %}
                        <p class="mt-1 text-lg font-semibold text-red-700">Expirée depuis {{ -days_left }} jours</p>
                    {% else %}
                        <p class="mt-1 text-lg font-semibold text-gray-500">-</p>
                    {% endif %}
                </div>

                <!-- Informations sur le client -->
                <div>
                    <h2 class="text-sm font-medium text-gray-500">Client</h2>
                    <p class="mt-1 text-lg text-gray-900">{{ license.client_name }}</p>
                </div>
                <div>
                    <h2 class="text-sm font-medium text-gray-500">Email du client</h2>
                    <p class="mt-1 text-lg text-gray-900">{{ license.client_email }}</p>
                </div>
                <div>
                    <h2 class="text-sm font-medium text-gray-500">Société</h2>
                    <p class="mt-1 text-lg text-gray-900">{{ license.company_name or 'Non spécifiée' }}</p>
                </div>
                
                <!-- Dates de création et d'expiration -->
                <div>
                    <h2 class="text-sm font-medium text-gray-500">Créée le</h2>
                    <p class="mt-1 text-lg text-gray-900">{{ license.created_at.strftime('%d %B %Y à %H:%M') }}</p>
                </div>
                <div>
                    <h2 class="text-sm font-medium text-gray-500">Expire le</h2>
                    <p class="mt-1 text-lg text-gray-900">{{ license.expires_at.strftime('%d %B %Y') }}</p>
                </div>
                 <div>
                    <h2 class="text-sm font-medium text-gray-500">Notes</h2>
                    <p class="mt-1 text-lg text-gray-900">{{ license.notes or 'Aucune note' }}</p>
                </div>
            </div>

            <!-- 
                Section des Actions
                -------------------
                Cette section contient les formulaires pour modifier la licence.
                La logique Jinja2 affiche les formulaires pertinents en fonction
                du statut de la licence.
            -->
            <div class="px-6 py-5 bg-gray-50 border-t border-gray-200">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Actions</h2>
                <div class="flex items-start gap-4">

                    <!-- Action: Prolonger la licence -->
                    <!-- S'affiche seulement si la licence n'est pas désactivée -->
                    {% if license.is_active %}
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-700">Prolonger la licence</h3>
                        <p class="text-sm text-gray-600 mb-2">Ajouter des jours à la date d'expiration actuelle.</p>
                        <!-- Le bouton ouvre la modale de prolongation -->
                        <button onclick="openModal('extendModal')" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition duration-300 text-sm">
                            Prolonger
                        </button>
                    </div>
                    {% endif %}

                    <!-- Action: Désactiver / Réactiver -->
                    <!-- Conditionnelle: le bloc affiché change si la licence est active ou non -->
                    <div class="flex-1">
                        {% if license.is_active %}
                            <!-- Formulaire pour désactiver une licence active -->
                            <h3 class="font-semibold text-gray-700">Désactiver la licence</h3>
                            <p class="text-sm text-gray-600 mb-2">La licence ne pourra plus être validée.</p>
                            <form action="/licenses/deactivate/{{ license.license_key }}" method="post">
                                <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition duration-300 text-sm">
                                    Désactiver
                                </button>
                            </form>
                        {% else %}
                            <!-- Formulaire pour réactiver une licence inactive -->
                            <h3 class="font-semibold text-gray-700">Réactiver la licence</h3>
                            <p class="text-sm text-gray-600 mb-2">La licence pourra de nouveau être validée.</p>
                            <form action="/licenses/reactivate/{{ license.license_key }}" method="post">
                                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition duration-300 text-sm">
                                    Réactiver
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 
        Modale pour la prolongation de la licence
        -----------------------------------------
        Cette fenêtre est cachée par défaut et s'affiche via JavaScript.
        Elle contient un formulaire pour soumettre le nombre de jours à ajouter.
    -->
    <div id="extendModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Prolonger la licence</h3>
                <div class="mt-2 px-7 py-3">
                    <form action="/licenses/extend/{{ license.license_key }}" method="post">
                        <label for="days_to_add" class="block text-sm font-medium text-gray-700 text-left">Jours à ajouter</label>
                        <input type="number" name="days_to_add" id="days_to_add" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ex: 365" required>
                        
                        <div class="items-center px-4 py-3 mt-4">
                            <button id="ok-btn" type="submit" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                Confirmer la prolongation
                            </button>
                        </div>
                    </form>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="cancel-btn" onclick="closeModal('extendModal')" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script JavaScript pour gérer l'ouverture et la fermeture de la modale -->
    <script>
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
    </script>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 